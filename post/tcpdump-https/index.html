<!DOCTYPE html>
<html lang="en-us" data-theme="light">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>tcpdump-https | Karthikeyan Sundararajan</title>

<link rel="stylesheet" href="https://karthikeayan.github.io//css/styles.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" 
integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>


<div class="container">
    <nav class="navbar level">
      <div class="navbar-brand">
          <a class="nav-item" href="https://karthikeayan.github.io/"><h1 class="title is-3">Karthikeyan Sundararajan</h1></a>
      </div>           
      <div class="navbar-menu has-text-centered is-active">
          <div class="navbar-end is-centered">
              
                <a href="https://karthikeayan.github.io/about.html" rel="me">
                  <span class="icon">
                    <i class="fas fa-info"></i>
                  </span>
                </a>
              
                <a href="https://github.com/karthikeayan" rel="me">
                  <span class="icon">
                    <i class="fab fa-github"></i>
                  </span>
                </a>
              
                <a href="https://www.linkedin.com/in/karthikeyan-sundararajan/" rel="me">
                  <span class="icon">
                    <i class="fab fa-linkedin-in"></i>
                  </span>
                </a>
              
                <a href="https://twitter.com/karthikeayan" rel="me">
                  <span class="icon">
                    <i class="fab fa-twitter"></i>
                  </span>
                </a>
              
           </div>
      </div>
    </nav>
  </div>

<div class="container">
  <h2 class="subtitle is-6">May 21, 2023</h2>
  <h1 class="subtitle is-size-4-mobile is-size-3-desktop">tcpdump-https</h1>
  <div class="content">
    <h1 id="how-to-capture-https-outbound-requestresponse-headers">How to capture HTTPS outbound request/response headers?</h1>
<p>What to do when you get unexpected HTTPS Response code from your application or any third party application which you are using that connects to Rest endpoint? Especially when we don&rsquo;t have access to the target Rest endpoint?
When we seek for help, everyone will suggest to see the response headers of the HTTPS request.
But how can we see the response header? There are couple of ways:</p>
<ul>
<li>Log HTTPS request/response header in your application - Quicker solution</li>
<li>Use any monitoring tools that provides this feature, could be costly</li>
<li>Look for any tool. Simple Google search will suggest to use Fiddler but from my quick look that is for local developement debugging.</li>
<li>Look for any other tool. HTTPToolKit looks promising but as of writing this article, it doesn&rsquo;t have headless feature. So, running this in your infra may be challenging. Especially in Kubernetes.</li>
<li>Stick with old school approach, tcpdump.</li>
</ul>
<h2 id="tcp-dump">TCP Dump</h2>
<p>Simple isn&rsquo;t it?</p>
<ul>
<li>Just take tcp dump by logging into the target pod/server</li>
<li>Install tcpdump (better copy the binary)</li>
<li>Take dump and copy it to your local</li>
<li>Load it to Wireshark</li>
</ul>
<p>Done, isn&rsquo;t it?</p>
<p>But you don&rsquo;t see any HTTPS traffic in the Wireshark UI. What are we missing?</p>
<p>Since HTTPS requests are HTTP over TLS. All the HTTPS requests are encrypted. We need the secrets to decrypt the data.</p>
<h2 id="what-is-sslkeylogfile">What is SSLKEYLOGFILE?</h2>
<p>It is an environment variable which is understood by most common used applications.</p>
<h3 id="does-curl-supports-it">Does Curl supports it?</h3>
<p>Yes, but only the Curl with SSL support. (Build curl with SSL support - <a href="https://stackoverflow.com/questions/28782556/how-do-i-get-curl-to-use-https">https://stackoverflow.com/questions/28782556/how-do-i-get-curl-to-use-https</a>)
Just set the value of SSLKEYLOGFILE to the file path in the shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#bc74c4">$</span> <span style="color:#7fbaf5">export</span> SSLKEYLOGFILE<span style="color:#bc74c4">=/</span>tmp<span style="color:#bc74c4">/</span>sslkeylogfile<span style="color:#bc74c4">.</span>log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># Start tcpdump in another shell</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">$</span> curl https<span style="color:#56b6c2">:</span><span style="color:#bc74c4">//</span>google<span style="color:#bc74c4">.</span>com
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">&lt;</span>HTML<span style="color:#bc74c4">&gt;&lt;</span>HEAD<span style="color:#bc74c4">&gt;&lt;</span>meta http<span style="color:#bc74c4">-</span>equiv<span style="color:#bc74c4">=</span><span style="color:#82cc6a">&#34;content-type&#34;</span> content<span style="color:#bc74c4">=</span><span style="color:#82cc6a">&#34;text/html;charset=utf-8&#34;</span><span style="color:#bc74c4">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">&lt;</span>TITLE<span style="color:#bc74c4">&gt;</span><span style="color:#56b6c2">301</span> Moved<span style="color:#bc74c4">&lt;/</span>TITLE<span style="color:#bc74c4">&gt;&lt;/</span>HEAD<span style="color:#bc74c4">&gt;&lt;</span>BODY<span style="color:#bc74c4">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">&lt;</span>H1<span style="color:#bc74c4">&gt;</span><span style="color:#56b6c2">301</span> Moved<span style="color:#bc74c4">&lt;/</span>H1<span style="color:#bc74c4">&gt;</span>
</span></span><span style="display:flex;"><span>The document has moved
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">&lt;</span>A HREF<span style="color:#bc74c4">=</span><span style="color:#82cc6a">&#34;https://www.google.com/&#34;</span><span style="color:#bc74c4">&gt;</span>here<span style="color:#bc74c4">&lt;/</span>A<span style="color:#bc74c4">&gt;.</span>
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">&lt;/</span>BODY<span style="color:#bc74c4">&gt;&lt;/</span>HTML<span style="color:#bc74c4">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">$</span> cat <span style="color:#bc74c4">/</span>tmp<span style="color:#bc74c4">/</span>SSLKEYLOGFILE
</span></span><span style="display:flex;"><span>CLIENT_RANDOM C76EE3XXXXX FB0CE69XXXXX
</span></span></code></pre></div><h3 id="does-browsers-supports-it">Does browsers supports it?</h3>
<p>Yes, Just set the value of SSLKEYLOGFILE to the file path in the shell and open browser from the shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#bc74c4">$</span> <span style="color:#7fbaf5">export</span> SSLKEYLOGFILE<span style="color:#bc74c4">=/</span>tmp<span style="color:#bc74c4">/</span>sslkeylogfile<span style="color:#bc74c4">.</span>log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># Start tcpdump in another shell</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">$</span> <span style="color:#bc74c4">/</span>Applications<span style="color:#bc74c4">/</span>Google\ Chrome<span style="color:#bc74c4">.</span>app<span style="color:#bc74c4">/</span>Contents<span style="color:#bc74c4">/</span>MacOS<span style="color:#bc74c4">/</span>Google\ Chrome
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#bc74c4">$</span> cat <span style="color:#bc74c4">/</span>tmp<span style="color:#bc74c4">/</span>SSLKEYLOGFILE
</span></span><span style="display:flex;"><span>CLIENT_RANDOM C76EE3XXXXX FB0CE69XXXXX
</span></span></code></pre></div><h2 id="tell-wireshark-to-use-the-sslkeylogfile">Tell Wireshark to use the SSLKEYLOGFILE</h2>
<p>Go to</p>
<ul>
<li>Wireshark Preferences</li>
<li>Protocols &ndash;&gt; TLS</li>
<li>(Pre)-Master-Secret log filename &ndash;&gt; Select /tmp/sslkeylogfile.log</li>
<li>Open dump file</li>
<li>Thats it, you can see the HTTPS requests</li>
</ul>
<h2 id="but-what-about-java-applications">But what about JAVA applications?</h2>
<p>Make use of Java Agents.</p>
<ul>
<li>Download this Jar file, <a href="https://github.com/neykov/extract-tls-secrets">https://github.com/neykov/extract-tls-secrets</a></li>
<li>Attach it to yoru Java application</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>java <span style="color:#bc74c4">-</span>javaagent<span style="color:#56b6c2">:</span><span style="color:#bc74c4">~/</span>Downloads<span style="color:#bc74c4">/</span>extract<span style="color:#bc74c4">-</span>tls<span style="color:#bc74c4">-</span>secrets<span style="color:#bc74c4">-</span><span style="color:#56b6c2">4.0</span><span style="color:#bc74c4">.</span><span style="color:#56b6c2">0.j</span>ar<span style="color:#bc74c4">=/</span>tmp<span style="color:#bc74c4">/</span>sslkeylogfile<span style="color:#bc74c4">.</span>log <span style="color:#bc74c4">-</span>jar MyApp<span style="color:#bc74c4">.</span>jar
</span></span></code></pre></div><ul>
<li>In Kubernetes, we can make use of JAVA_TOOL_OPTIONS environment varilable.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>env<span style="color:#56b6c2">:</span>
</span></span><span style="display:flex;"><span>  name<span style="color:#56b6c2">:</span> JAVA_TOOL_OPTIONS
</span></span><span style="display:flex;"><span>  value<span style="color:#56b6c2">:</span> <span style="color:#bc74c4">-</span>javaagent<span style="color:#56b6c2">:</span><span style="color:#bc74c4">~/</span>Downloads<span style="color:#bc74c4">/</span>extract<span style="color:#bc74c4">-</span>tls<span style="color:#bc74c4">-</span>secrets<span style="color:#bc74c4">-</span><span style="color:#56b6c2">4.0</span><span style="color:#bc74c4">.</span><span style="color:#56b6c2">0.j</span>ar<span style="color:#bc74c4">=/</span>tmp<span style="color:#bc74c4">/</span>sslkeylogfile<span style="color:#bc74c4">.</span>log
</span></span></code></pre></div>
  </div>
</div>
<div class="container has-text-centered">
    
</div>

<div class="container has-text-centered">
  
</div>

<section class="section py-0">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>

