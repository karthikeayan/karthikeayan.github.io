<!DOCTYPE html>
<html lang="en-us" data-theme="light">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>aws-cur-report-read-nat-gateway-example | Karthikeyan Sundararajan</title>

<link rel="stylesheet" href="https://karthikeayan.github.io//css/styles.css">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" 
integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>


<div class="container">
    <nav class="navbar level">
      <div class="navbar-brand">
          <a class="nav-item" href="https://karthikeayan.github.io/"><h1 class="title is-3">Karthikeyan Sundararajan</h1></a>
      </div>           
      <div class="navbar-menu has-text-centered is-active">
          <div class="navbar-end is-centered">
              
                <a href="https://karthikeayan.github.io/about.html" rel="me">
                  <span class="icon">
                    <i class="fas fa-info"></i>
                  </span>
                </a>
              
                <a href="https://github.com/karthikeayan" rel="me">
                  <span class="icon">
                    <i class="fab fa-github"></i>
                  </span>
                </a>
              
                <a href="https://www.linkedin.com/in/karthikeyan-sundararajan/" rel="me">
                  <span class="icon">
                    <i class="fab fa-linkedin-in"></i>
                  </span>
                </a>
              
                <a href="https://twitter.com/karthikeayan" rel="me">
                  <span class="icon">
                    <i class="fab fa-twitter"></i>
                  </span>
                </a>
              
           </div>
      </div>
    </nav>
  </div>

<div class="container">
  <h2 class="subtitle is-6">May 16, 2025</h2>
  <h1 class="subtitle is-size-4-mobile is-size-3-desktop">aws-cur-report-read-nat-gateway-example</h1>
  <div class="content">
    <h1 id="read-aws-cur-report-to-understand-nat-gateway-usage-by-id">Read AWS CUR Report to understand NAT Gateway usage by ID</h1>
<p>Build Jupyter Notebook Image with below Dockerfile</p>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>FROM python<span style="color:#56b6c2">:</span><span style="color:#56b6c2">3.13</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># Set the working directory to /app</span>
</span></span><span style="display:flex;"><span>WORKDIR <span style="color:#bc74c4">/</span>app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># Install Jupyter Notebook</span>
</span></span><span style="display:flex;"><span>RUN pip install jupyter<span style="color:#bc74c4">===</span><span style="color:#56b6c2">1.1</span><span style="color:#bc74c4">.</span><span style="color:#56b6c2">1</span>
</span></span><span style="display:flex;"><span>RUN pip install pandas
</span></span><span style="display:flex;"><span>RUN pip install awscli
</span></span><span style="display:flex;"><span>RUN pip install boto3
</span></span><span style="display:flex;"><span>RUN pip install fsspec
</span></span><span style="display:flex;"><span>RUN pip install s3fs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># Make port 8888 available to the world outside this container</span>
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#56b6c2">8888</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># Define environment variable</span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># ENV NAME World</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3e4460"># Run Jupyter Notebook when the container launches</span>
</span></span><span style="display:flex;"><span>CMD <span style="color:#56b6c2">[</span><span style="color:#82cc6a">&#34;jupyter&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#82cc6a">&#34;notebook&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#82cc6a">&#34;--ip=0.0.0.0&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#82cc6a">&#34;--port=8888&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#82cc6a">&#34;--no-browser&#34;</span><span style="color:#56b6c2">,</span> <span style="color:#82cc6a">&#34;--allow-root&#34;</span><span style="color:#56b6c2">]</span>
</span></span></code></pre></div><p>Build and push the image to container registry</p>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>docker build . -t jupyter-notebook:1.1.1
</span></span><span style="display:flex;"><span>docker push jupyter-notebook:1.1.1
</span></span></code></pre></div><p>Deploy to Kubernetes</p>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Namespace
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: jupyter-notebook
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: PersistentVolumeClaim
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: jupyter-notebook
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  accessModes:
</span></span><span style="display:flex;"><span>    - ReadWriteOnce
</span></span><span style="display:flex;"><span>  resources:
</span></span><span style="display:flex;"><span>    requests:
</span></span><span style="display:flex;"><span>      storage: 5Gi
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ConfigMap
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: jupyter-notebook-token
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  jupyter_notebook_config.py: |
</span></span><span style="display:flex;"><span>    c.NotebookApp.token = &#39;1234RANDOM_TOKENc56789&#39;
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: apps/v1
</span></span><span style="display:flex;"><span>kind: Deployment
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: jupyter-notebook
</span></span><span style="display:flex;"><span>  namespace: jupyter-notebook
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    app: jupyter-notebook
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  replicas: 1
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: jupyter-notebook
</span></span><span style="display:flex;"><span>  template:
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: jupyter-notebook
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - name: jupyter-notebook
</span></span><span style="display:flex;"><span>        image: jupyter-notebook:1.1.1
</span></span><span style="display:flex;"><span>        imagePullPolicy: Always
</span></span><span style="display:flex;"><span>        resources:
</span></span><span style="display:flex;"><span>          requests:
</span></span><span style="display:flex;"><span>            memory: 14G
</span></span><span style="display:flex;"><span>        ports:
</span></span><span style="display:flex;"><span>        - containerPort: 8888
</span></span><span style="display:flex;"><span>        volumeMounts:
</span></span><span style="display:flex;"><span>        - name: storage
</span></span><span style="display:flex;"><span>          mountPath: /app
</span></span><span style="display:flex;"><span>        - name: config-volume
</span></span><span style="display:flex;"><span>          mountPath: /root/.jupyter/jupyter_notebook_config.py
</span></span><span style="display:flex;"><span>          subPath: jupyter_notebook_config.py
</span></span><span style="display:flex;"><span>      volumes:
</span></span><span style="display:flex;"><span>      - name: storage
</span></span><span style="display:flex;"><span>        persistentVolumeClaim:
</span></span><span style="display:flex;"><span>          claimName: jupyter-notebook
</span></span><span style="display:flex;"><span>      - name: config-volume
</span></span><span style="display:flex;"><span>        configMap:
</span></span><span style="display:flex;"><span>          name: jupyter-notebook-token
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: jupyter-notebook
</span></span><span style="display:flex;"><span>  namespace: jupyter-notebook
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: jupyter-notebook
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - protocol: TCP
</span></span><span style="display:flex;"><span>      port: 80
</span></span><span style="display:flex;"><span>      targetPort: 8888
</span></span><span style="display:flex;"><span>  type: ClusterIP
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>apiVersion: networking.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: jupyter-notebook
</span></span><span style="display:flex;"><span>  namespace: jupyter-notebook
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    kubernetes.io/ingress.class: nginx
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>    - host: jupyter.mycompany.com
</span></span><span style="display:flex;"><span>      http:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>          - path: /
</span></span><span style="display:flex;"><span>            pathType: Prefix
</span></span><span style="display:flex;"><span>            backend:
</span></span><span style="display:flex;"><span>              service:
</span></span><span style="display:flex;"><span>                name: jupyter-notebook
</span></span><span style="display:flex;"><span>                port:
</span></span><span style="display:flex;"><span>                  number: 80
</span></span></code></pre></div><p>Python snippet to read the CUR from AWS S3 and group the NAT Gateway cost by ID</p>
<div class="highlight"><pre tabindex="0" style="color:#c9c9c9;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># Approximate execution time: 500 seconds
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import boto3
</span></span><span style="display:flex;"><span>from io import BytesIO
</span></span><span style="display:flex;"><span>import pandas as pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s3 = boto3.client(&#34;s3&#34;)
</span></span><span style="display:flex;"><span>bucket_name = &#34;YOUR_BUCKET_NAME&#34;
</span></span><span style="display:flex;"><span>prefix = &#34;CUR/MyCostReport/20250401-20250501/&#34;  # Adjust based on your report structure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># List all files in the CUR folder
</span></span><span style="display:flex;"><span>response = s3.list_objects_v2(Bucket=bucket_name, Prefix=prefix)
</span></span><span style="display:flex;"><span>files = [obj[&#34;Key&#34;] for obj in response.get(&#34;Contents&#34;, []) if obj[&#34;Key&#34;].endswith(&#34;.csv.gz&#34;)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chunksize = 10000
</span></span><span style="display:flex;"><span>agg_dict = {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Process all files
</span></span><span style="display:flex;"><span>for file_key in files:
</span></span><span style="display:flex;"><span>    response = s3.get_object(Bucket=bucket_name, Key=file_key)
</span></span><span style="display:flex;"><span>    file_content = BytesIO(response[&#34;Body&#34;].read())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    for chunk in pd.read_csv(file_content, compression=&#34;gzip&#34;, low_memory=False, chunksize=chunksize):
</span></span><span style="display:flex;"><span>        chunk_filtered = chunk.loc[chunk[&#34;product/groupDescription&#34;] == &#34;Charge for per GB data processed by NatGateways&#34;]
</span></span><span style="display:flex;"><span>        grouped_chunk = chunk_filtered.groupby([&#34;lineItem/ResourceId&#34;, &#34;lineItem/UsageAccountId&#34;])[&#34;lineItem/BlendedCost&#34;].sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        for index, value in grouped_chunk.items():
</span></span><span style="display:flex;"><span>            agg_dict[index] = agg_dict.get(index, 0) + value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Convert results to DataFrame
</span></span><span style="display:flex;"><span>df_grouped = pd.DataFrame(list(agg_dict.items()), columns=[&#34;Resource_Account&#34;, &#34;BlendedCost&#34;])
</span></span><span style="display:flex;"><span>df_sorted = df_grouped.sort_values(by=&#34;BlendedCost&#34;, ascending=False)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(df_sorted.to_string(index=False))
</span></span></code></pre></div><p>In the above script, I used 10000 as chunksize, you can adjust this based on the memory of your Jupyter Notebook container memory</p>

  </div>
</div>
<div class="container has-text-centered">
    
</div>

<div class="container has-text-centered">
  
</div>

<section class="section py-0">
  <div class="container has-text-centered">
    <p></p>
  </div>
</section>

